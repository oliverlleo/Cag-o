import React, { useState, useEffect, useRef } from 'react';
import { 
  Trophy, 
  Zap, 
  Clock, 
  ArrowUpCircle, 
  Scroll, 
  Smartphone, 
  Rocket, 
  AlertTriangle,
  Leaf,
  Castle,
  Home,
  Cpu,
  Music
} from 'lucide-react';

// --- CONFIGURA√á√ÉO DO JOGO ---

const ERAS = [
  {
    id: 0,
    name: "Pr√©-Hist√≥ria",
    description: "Onde tudo come√ßou. Apenas voc√™ e a natureza.",
    color: "bg-green-900",
    textColor: "text-green-100",
    buttonColor: "bg-green-600 hover:bg-green-500",
    icon: <Leaf size={64} />,
    bgPattern: "opacity-10 custom-bg-pattern-leaf",
    multiplier: 1,
    cost: 0
  },
  {
    id: 1,
    name: "Idade M√©dia",
    description: "Um trono de madeira. R√∫stico, mas funciona.",
    color: "bg-amber-900",
    textColor: "text-amber-100",
    buttonColor: "bg-amber-700 hover:bg-amber-600",
    icon: <Castle size={64} />,
    bgPattern: "opacity-10 custom-bg-pattern-stone",
    multiplier: 5,
    cost: 1500
  },
  {
    id: 2,
    name: "Era Moderna",
    description: "Porcelana fria, Wi-Fi e conforto.",
    color: "bg-blue-700",
    textColor: "text-blue-100",
    buttonColor: "bg-blue-500 hover:bg-blue-400",
    icon: <Home size={64} />,
    bgPattern: "opacity-10 custom-bg-pattern-tile",
    multiplier: 25,
    cost: 50000
  },
  {
    id: 3,
    name: "Futuro Gal√°ctico",
    description: "Cagando em gravidade zero. O √°pice da evolu√ß√£o.",
    color: "bg-purple-900",
    textColor: "text-purple-100",
    buttonColor: "bg-fuchsia-600 hover:bg-fuchsia-500",
    icon: <Cpu size={64} />,
    bgPattern: "opacity-20 custom-bg-pattern-stars",
    multiplier: 100,
    cost: 1000000
  }
];

const UPGRADE_DEFS = [
  { id: 1, name: "Folha de Bananeira", type: "click", basePower: 0.5, baseCost: 10, costMult: 1.5, eraReq: 0, icon: <Leaf size={16}/> },
  { id: 2, name: "Revista Velha", type: "auto", basePower: 0.2, baseCost: 50, costMult: 1.6, eraReq: 0, icon: <Scroll size={16}/> },
  { id: 3, name: "Jornal do Reino", type: "click", basePower: 2, baseCost: 250, costMult: 1.5, eraReq: 1, icon: <Scroll size={16}/> },
  { id: 4, name: "Balde d'√Ågua", type: "auto", basePower: 1.5, baseCost: 600, costMult: 1.6, eraReq: 1, icon: <Zap size={16}/> },
  { id: 5, name: "Smartphone", type: "click", basePower: 10, baseCost: 2500, costMult: 1.5, eraReq: 2, icon: <Smartphone size={16}/> },
  { id: 6, name: "Fibra √ìptica", type: "auto", basePower: 5, baseCost: 5000, costMult: 1.6, eraReq: 2, icon: <Zap size={16}/> },
  { id: 7, name: "Implante Neural", type: "click", basePower: 50, baseCost: 50000, costMult: 1.5, eraReq: 3, icon: <Cpu size={16}/> },
  { id: 8, name: "Teleporte de Detritos", type: "auto", basePower: 20, baseCost: 100000, costMult: 1.6, eraReq: 3, icon: <Rocket size={16}/> },
];

export default function ToiletEvolution() {
  // --- STATE ---
  const [coins, setCoins] = useState(0);
  const [relief, setRelief] = useState(0);
  const [strain, setStrain] = useState(0);
  
  const [clickPower, setClickPower] = useState(1);
  const [autoRate, setAutoRate] = useState(0);
  const [eraIndex, setEraIndex] = useState(0);
  const [ownedUpgrades, setOwnedUpgrades] = useState<{[key: number]: number}>({});
  
  const [isJammed, setIsJammed] = useState(false);
  const [message, setMessage] = useState("");
  const [floatText, setFloatText] = useState<{id: number, text: string, x: number, y: number, type: 'good' | 'bad' | 'neutral'}[]>([]);
  const [shake, setShake] = useState(false);

  // --- STATE DO BOT√ÉO HOLD E IMAGEM ---
  const [isHolding, setIsHolding] = useState(false);
  const isHoldingRef = useRef(false);
  const holdTimerRef = useRef<number | null>(null);
  
  // Estado para controlar qual imagem mostrar
  const [currentImage, setCurrentImage] = useState('inicio.jpg');

  // --- RHYTHM MECHANIC STATE (REFS) ---
  const [rhythmVisualScale, setRhythmVisualScale] = useState(2.2); 
  const rhythmScaleRef = useRef(2.2); 
  const rhythmActiveRef = useRef(false);
  
  const currentSpeedRef = useRef(1.2);
  const lastInputRef = useRef(0);
  const hitCooldownRef = useRef(false);
  
  const [rhythmActiveState, setRhythmActiveState] = useState(false); 
  const [rhythmWarning, setRhythmWarning] = useState(false);
  const [comboMultiplier, setComboMultiplier] = useState(1.0);
  
  const loopRef = useRef<number>();
  const lastTimeRef = useRef<number>(Date.now());
  const floatTextCounter = useRef(0);
  const nextRhythmTriggerRef = useRef<number>(Date.now() + 5000); 

  const currentEra = ERAS[eraIndex];
  const nextEra = ERAS[eraIndex + 1];

  // --- C√ÅLCULO DE STATUS DIN√ÇMICO ---
  useEffect(() => {
    let clickP = 1; 
    let autoP = 0;
    UPGRADE_DEFS.forEach(up => {
      const level = ownedUpgrades[up.id] || 0;
      if (level > 0) {
        if (up.type === 'click') clickP += up.basePower * level;
        else autoP += up.basePower * level;
      }
    });
    setClickPower(clickP);
    setAutoRate(autoP);
  }, [ownedUpgrades]);

  // --- HELPER: FLOATING TEXT ---
  const spawnFloatText = (text: string, x: number, y: number, type: 'good' | 'bad' | 'neutral' = 'neutral') => {
    const id = floatTextCounter.current++;
    setFloatText(prev => [...prev, { id, text, x, y, type }]);
    setTimeout(() => {
      setFloatText(prev => prev.filter(ft => ft.id !== id));
    }, 1000);
  };

  // --- HELPER: L√ìGICA DE VELOCIDADE 3x, 5x, 7x ---
  const getNextDynamicSpeed = (currentCombo: number) => {
    const BASE_SPEED = 1.2; 
    let chaosChance = 0.05; 
    let fastCap = 1.4; 
    let slowCap = 0.9;

    if (currentCombo >= 3.0 && currentCombo < 5.0) {
        chaosChance = 0.25; fastCap = 1.6; slowCap = 0.8;
    } else if (currentCombo >= 5.0 && currentCombo < 7.0) {
        chaosChance = 0.50; fastCap = 1.8; slowCap = 0.7;
    } else if (currentCombo >= 7.0 && currentCombo < 9.0) {
        chaosChance = 0.75; fastCap = 2.0; slowCap = 0.6;
    } else if (currentCombo >= 9.0) {
        chaosChance = 0.95; fastCap = 2.2; slowCap = 0.5;
    }

    if (Math.random() < chaosChance) {
        const isFast = Math.random() > 0.5;
        if (isFast) {
            return BASE_SPEED + 0.2 + (Math.random() * (fastCap - (BASE_SPEED + 0.2)));
        } else {
            return slowCap + (Math.random() * 0.2);
        }
    }
    return BASE_SPEED;
  };

  // --- EFEITOS E LOOP ---

  useEffect(() => {
    const saved = localStorage.getItem('toilet-evo-v10_clean');
    if (saved) {
      try {
        const data = JSON.parse(saved);
        if (data) {
            setCoins(data.coins || 0);
            setEraIndex(data.eraIndex || 0);
            setOwnedUpgrades(data.ownedUpgrades || {});
        }
      } catch (e) { console.error("Save corrompido, resetando."); }
    }
  }, []);

  useEffect(() => {
    const data = { coins, eraIndex, ownedUpgrades };
    localStorage.setItem('toilet-evo-v10_clean', JSON.stringify(data));
  }, [coins, eraIndex, ownedUpgrades]);

  const scheduleNextRhythm = () => {
    const delay = 15000 + Math.random() * 15000;
    nextRhythmTriggerRef.current = Date.now() + delay;
  };

  const triggerWarning = () => {
    setRhythmWarning(true);
    setTimeout(() => {
      setRhythmWarning(false);
      startRhythmSequence();
    }, 1500);
  };

  const startRhythmSequence = () => {
    rhythmActiveRef.current = true;
    rhythmScaleRef.current = 2.2;
    currentSpeedRef.current = getNextDynamicSpeed(1.0); 
    setRhythmActiveState(true);
    setRhythmVisualScale(2.2);
    hitCooldownRef.current = false; 
  };

  const stopRhythmSequence = (resetCombo = true) => {
    rhythmActiveRef.current = false;
    setRhythmActiveState(false);
    scheduleNextRhythm();
    if (resetCombo) setComboMultiplier(1.0);
  };

  // Game Loop
  useEffect(() => {
    const gameLoop = () => {
      const now = Date.now();
      const dt = (now - lastTimeRef.current) / 1000; 
      lastTimeRef.current = now;

      if (dt > 0.5) return;

      if (!isJammed) {
        if (autoRate > 0) {
            const autoGain = autoRate * dt; 
            setRelief(prev => {
                const nextVal = prev + autoGain;
                if (nextVal >= 100) return 100;
                return nextVal;
            });
        }

        let strainDecay = 20 * dt;
        if (isHoldingRef.current) {
            strainDecay += 40 * dt; 
        }
        setStrain(prev => Math.max(0, prev - strainDecay));

        if (!rhythmActiveRef.current && !rhythmWarning && now > nextRhythmTriggerRef.current) {
          triggerWarning();
          nextRhythmTriggerRef.current = now + 999999;
        }

        if (rhythmActiveRef.current) {
          rhythmScaleRef.current -= (currentSpeedRef.current * dt);
          setRhythmVisualScale(rhythmScaleRef.current);

          if (rhythmScaleRef.current <= 0.80) { 
             handleRhythmMiss("TARDE!");
          }
        }

      } else {
        if (rhythmActiveRef.current || rhythmWarning) {
            stopRhythmSequence(true);
        }
        let recoveryRate = 25 * dt;
        if (isHoldingRef.current) {
            recoveryRate += 15 * dt;
        }
        setStrain(prev => {
          const newVal = prev - recoveryRate;
          if (newVal <= 0) setIsJammed(false);
          return Math.max(0, newVal);
        });
      }

      loopRef.current = requestAnimationFrame(gameLoop);
    };

    loopRef.current = requestAnimationFrame(gameLoop);
    return () => cancelAnimationFrame(loopRef.current!);
  }, [autoRate, currentEra, isJammed, rhythmWarning, comboMultiplier]);

  useEffect(() => {
      if (relief >= 100) {
          completeSession(1.0); 
      }
  }, [relief]);


  // --- HANDLERS ---

  const handleRhythmMiss = (reason = "ERROU!") => {
      stopRhythmSequence(true); 
      spawnFloatText(reason, 50, 40, 'bad');
  };

  const checkRhythmHit = () => {
      const s = rhythmScaleRef.current;
      
      const TOO_EARLY_LIMIT = 1.05; 
      const TOO_LATE_LIMIT = 0.82;  
      
      if (s > TOO_EARLY_LIMIT) {
          handleRhythmMiss("CEDO!");
          return false;
      }
      if (s < TOO_LATE_LIMIT) {
          handleRhythmMiss("TARDE!");
          return false;
      }
      
      rhythmScaleRef.current = 2.2;
      setRhythmVisualScale(2.2);

      const nextCombo = parseFloat((comboMultiplier + 0.1).toFixed(1));
      setComboMultiplier(nextCombo);

      currentSpeedRef.current = getNextDynamicSpeed(nextCombo);
      
      let speedMsg = "BOA!";
      if (currentSpeedRef.current > 1.6) speedMsg = "R√ÅPIDO!";
      if (currentSpeedRef.current < 0.9) speedMsg = "LENTO...";

      spawnFloatText(speedMsg, 50, 30, 'good');
      setStrain(prev => Math.max(0, prev - 30));

      return true;
  };

  const handlePush = (e: React.MouseEvent | React.TouchEvent) => {
    const now = Date.now();
    if (now - lastInputRef.current < 30) return; 
    
    const timeDelta = now - lastInputRef.current;
    lastInputRef.current = now;

    if (isJammed) return;

    let currentClickMult = 1;
    let strainGain = 0; 

    if (rhythmActiveRef.current) {
        if (hitCooldownRef.current) return;

        const hit = checkRhythmHit();
        if (hit) {
            hitCooldownRef.current = true;
            setTimeout(() => hitCooldownRef.current = false, 200);

            currentClickMult = parseFloat((comboMultiplier + 0.1).toFixed(1)); 
            strainGain = -5;
            
            setShake(true);
            setTimeout(() => setShake(false), 100);
        } else {
            strainGain = 10; 
        }
    } else {
        if (timeDelta < 150) { 
            strainGain = 8;
        } else if (timeDelta < 400) {
            strainGain = 2; 
        } else {
            strainGain = 0; 
            if (timeDelta > 700) strainGain = -2; 
        }

        currentClickMult = 1;
        setShake(true);
        setTimeout(() => setShake(false), 50);
    }

    const newStrain = Math.min(100, Math.max(0, strain + strainGain));
    setStrain(newStrain);

    if (newStrain >= 100) {
      setIsJammed(true);
      stopRhythmSequence(true);
      setMessage("PERNA DORMIU!");
      navigator.vibrate?.(500);
      return;
    }

    const baseReliefGain = clickPower * 0.8;
    const finalReliefGain = baseReliefGain * currentClickMult;

    setRelief(prev => {
        const nextVal = prev + finalReliefGain;
        return Math.min(100, nextVal); 
    });
  };

  // --- HOLD HANDLERS (COM TIMER DE 300ms e Mudan√ßa de Imagem) ---
  const startHold = (e: React.MouseEvent | React.TouchEvent) => {
      handlePush(e);
      
      // Troca para imagem de for√ßa imediatamente ao apertar
      setCurrentImage('forca.jpg');

      if (holdTimerRef.current) clearTimeout(holdTimerRef.current);
      
      holdTimerRef.current = window.setTimeout(() => {
          setIsHolding(true);
          isHoldingRef.current = true;
      }, 300);
  };

  const endHold = () => {
      if (holdTimerRef.current) {
          clearTimeout(holdTimerRef.current);
          holdTimerRef.current = null;
      }
      setIsHolding(false);
      isHoldingRef.current = false;
      
      // Ao soltar, muda para 'quase.jpg' e depois de um tempo volta para 'inicio.jpg'
      setCurrentImage('quase.jpg');
      setTimeout(() => {
          // S√≥ volta para inicio se n√£o tiver completado o al√≠vio (que mudaria para alivio.jpg)
          if (relief < 100) {
             setCurrentImage('inicio.jpg');
          }
      }, 500); // Fica 0.5s na imagem 'quase' antes de voltar
  };

  const completeSession = (finalMult: number) => {
    setRelief(0);
    const baseReward = 10;
    const reward = baseReward * currentEra.multiplier * finalMult;
    setCoins(prev => prev + reward);
    
    // Mostra imagem de al√≠vio e depois volta para inicio
    setCurrentImage('alivio.jpg');
    setTimeout(() => {
        setCurrentImage('inicio.jpg');
    }, 1500); // Fica 1.5s na imagem de al√≠vio
  };

  const buyUpgrade = (upgrade: typeof UPGRADE_DEFS[0]) => {
    const currentLevel = ownedUpgrades[upgrade.id] || 0;
    const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMult, currentLevel));

    if (coins >= cost) {
      setCoins(prev => prev - cost);
      setOwnedUpgrades(prev => ({
          ...prev,
          [upgrade.id]: currentLevel + 1
      }));
    }
  };

  const evolveEra = () => {
    if (nextEra && coins >= nextEra.cost) {
      setCoins(prev => prev - nextEra.cost);
      setEraIndex(prev => prev + 1);
      setMessage(`BEM VINDO √Ä ${nextEra.name.toUpperCase()}!`);
      navigator.vibrate?.([200, 100, 200]);
      setTimeout(() => setMessage(""), 3000);
    }
  };

  return (
    <div className={`w-full h-screen overflow-hidden flex flex-col ${currentEra.color} ${currentEra.textColor} font-sans select-none transition-colors duration-1000 relative`}>
      
      <style>{`
        .custom-bg-pattern-leaf { background-image: radial-gradient(circle, #ffffff 2px, transparent 2.5px); background-size: 24px 24px; }
        .custom-bg-pattern-stone { background-image: repeating-linear-gradient(45deg, #0000 0, #0000 10px, #0003 10px, #0003 12px); }
        .custom-bg-pattern-tile { background-image: linear-gradient(0deg, transparent 24%, #ffffff 25%, #ffffff 26%, transparent 27%, transparent 74%, #ffffff 75%, #ffffff 76%, transparent 77%, transparent), linear-gradient(90deg, transparent 24%, #ffffff 25%, #ffffff 26%, transparent 27%, transparent 74%, #ffffff 75%, #ffffff 76%, transparent 77%, transparent); background-size: 30px 30px; }
        .custom-bg-pattern-stars { background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px); background-size: 50px 50px; }
        
        @keyframes glow-warning {
          0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); transform: scale(1); }
          50% { box-shadow: 0 0 40px 10px rgba(255, 215, 0, 0.5); transform: scale(1.05); }
        }
        .animate-glow { animation: glow-warning 0.5s infinite; }
      `}</style>

      <div className={`absolute inset-0 pointer-events-none ${currentEra.bgPattern}`} />

      {/* HEADER */}
      <div className="relative z-10 p-4 flex justify-between items-center bg-black/20 backdrop-blur-sm border-b border-white/10">
        <div>
          <h1 className="text-sm opacity-70 uppercase tracking-wider font-bold">Toilet Evolution</h1>
          <div className="text-xs">{currentEra.name}</div>
        </div>
        <div className="flex flex-col items-end gap-1">
          <div className="bg-yellow-500 text-yellow-900 px-3 py-1 rounded-full font-bold shadow-lg flex items-center gap-1">
            <span className="text-lg">ü™ô</span>
            <span>{Math.floor(coins).toLocaleString()}</span>
          </div>
        </div>
      </div>

      {/* DISPLAY FIXO DO MULTIPLICADOR DE RITMO */}
      <div className={`absolute top-20 right-4 z-50 transition-all duration-300 ${comboMultiplier > 1.0 ? 'opacity-100 scale-100' : 'opacity-0 scale-90 pointer-events-none'}`}>
          <div className="bg-black/60 backdrop-blur border-2 border-yellow-400 rounded-lg px-4 py-2 flex flex-col items-center shadow-lg animate-pulse">
              <span className="text-[10px] text-yellow-200 uppercase font-bold tracking-widest flex items-center gap-1"><Music size={10}/> Ritmo</span>
              <div className="text-3xl font-black text-yellow-400 drop-shadow-md flex items-center gap-1">
                  x{comboMultiplier.toFixed(1)}
              </div>
          </div>
      </div>

      {/* √ÅREA DE JOGO */}
      <div className="flex-1 relative flex flex-col items-center justify-center p-4">
        
        {floatText.map(ft => (
            <div 
                key={ft.id}
                className={`absolute pointer-events-none font-black text-2xl z-50 animate-float
                    ${ft.type === 'good' ? 'text-yellow-300 text-4xl drop-shadow-md' : ''}
                    ${ft.type === 'bad' ? 'text-red-500' : ''}
                    ${ft.type === 'neutral' ? 'text-white' : ''}
                `}
                style={{ left: `${ft.x}%`, top: `${ft.y}%` }}
            >
                {ft.text}
            </div>
        ))}

        <div className="h-12 flex items-center justify-center text-center mb-2 font-bold text-lg drop-shadow-md z-50 text-white">
          {message}
        </div>

        <div className="relative w-64 h-64 flex items-center justify-center mb-6">
          
          {/* ANEL DE RITMO */}
          {rhythmActiveState && (
              <>
                {/* ALVO FIXO: BORDER-24PX DEFINIDO POR STYLE */}
                <div 
                    className="absolute rounded-full border-white/30 z-0 shadow-[0_0_30px_10px_rgba(255,255,255,0.15)]"
                    style={{ 
                        width: '208px',  // w-52
                        height: '208px', // h-52
                        borderWidth: '24px',
                        boxSizing: 'border-box'
                    }}
                ></div>
                
                {/* ANEL M√ìVEL: BORDER-8PX DEFINIDO POR STYLE */}
                <div 
                    className="absolute rounded-full border-yellow-400 z-20 shadow-[0_0_20px_rgba(255,215,0,0.8)]"
                    style={{ 
                        width: '208px',
                        height: '208px',
                        borderWidth: '8px',
                        boxSizing: 'border-box',
                        transform: `scale(${rhythmVisualScale})`,
                    }}
                ></div>
              </>
          )}

          {/* Avatar Central (Agora usa as imagens) */}
          <div 
            className={`
                relative w-40 h-40 rounded-full backdrop-blur-md flex items-center justify-center shadow-2xl border-4 border-white/20 z-10 transition-all duration-200 overflow-hidden
                ${isHolding ? 'scale-95 border-red-400' : 'scale-100'}
                ${isJammed ? 'grayscale opacity-50' : ''}
                ${rhythmWarning ? 'animate-glow border-yellow-400' : ''}
                ${rhythmActiveState ? 'border-white/50' : ''}
            `}
          >
             {/* Imagem do Personagem */}
             <img 
                 src={currentImage} 
                 alt="Personagem" 
                 className={`w-full h-full object-cover ${isJammed ? 'opacity-50' : ''}`}
             />
             
             {isJammed && (
                <div className="absolute inset-0 flex items-center justify-center">
                  <AlertTriangle size={60} className="text-red-500 animate-pulse" />
                </div>
             )}
          </div>

        </div>

        {/* BARRAS */}
        <div className="w-full max-w-xs space-y-3 mb-6">
          <div className="relative">
             <div className="flex justify-between text-xs mb-1 font-bold opacity-80">
               <span>AL√çVIO</span>
               <span>{Math.floor(relief)}%</span>
             </div>
             <div className="h-6 w-full bg-black/40 rounded-full overflow-hidden border border-white/10">
               <div 
                  className="h-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-100 ease-out"
                  style={{ width: `${relief}%` }}
               />
             </div>
          </div>

          <div className="relative">
             <div className="flex justify-between text-xs mb-1 font-bold opacity-80">
               <span className={`${strain > 80 ? 'text-red-300 animate-pulse' : ''}`}>PRESS√ÉO (CUIDADO!)</span>
               <span>{Math.floor(strain)}%</span>
             </div>
             <div className="h-4 w-full bg-black/40 rounded-full overflow-hidden border border-white/10">
               <div 
                  className={`h-full transition-all duration-100 ease-out ${strain > 80 ? 'bg-red-500' : 'bg-orange-400'}`}
                  style={{ width: `${strain}%` }}
               />
             </div>
          </div>
        </div>

        {/* BUTTON AREA (Invis√≠vel, controla o toque) */}
        <button
          onMouseDown={startHold}
          onTouchStart={startHold}
          onMouseUp={endHold}
          onMouseLeave={endHold}
          onTouchEnd={endHold}
          disabled={isJammed}
          className="absolute inset-0 top-20 bottom-1/3 z-30 cursor-pointer outline-none touch-manipulation bg-transparent"
          style={{ WebkitTapHighlightColor: 'transparent' }}
        >
            {rhythmWarning && (
                <div className="absolute top-[40%] left-0 right-0 text-center text-yellow-300 font-bold text-2xl animate-pulse pointer-events-none drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">
                    RITMO!
                </div>
            )}
        </button>
        
        <div className="mt-2 text-xs opacity-60 flex gap-4 z-20 pointer-events-none">
           <span className="flex items-center gap-1"><Zap size={12}/> For√ßa: {clickPower.toFixed(1)}</span>
           <span className="flex items-center gap-1"><Clock size={12}/> Auto: {autoRate.toFixed(1)}%/s</span>
        </div>
      </div>

      {/* LOJA REFORMULADA (LISTA DE ITENS INFINITOS) */}
      <div className="h-1/3 bg-black/30 backdrop-blur-md rounded-t-3xl border-t border-white/10 flex flex-col overflow-hidden z-40">
        <div className="p-4 border-b border-white/10 flex justify-between items-center sticky top-0 bg-black/20 backdrop-blur z-20">
          <h2 className="font-bold flex items-center gap-2"><Trophy size={18}/> Loja</h2>
          
          {nextEra && (
            <button 
              onClick={evolveEra}
              disabled={coins < nextEra.cost}
              className={`text-xs px-3 py-1 rounded-full font-bold flex items-center gap-1 transition-colors
                ${coins >= nextEra.cost 
                  ? 'bg-gradient-to-r from-yellow-400 to-orange-500 text-black animate-pulse' 
                  : 'bg-gray-700 text-gray-400'}
              `}
            >
              <ArrowUpCircle size={14} /> 
              Evoluir ({nextEra.cost.toLocaleString()})
            </button>
          )}
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-8">
          {UPGRADE_DEFS.filter(u => u.eraReq <= eraIndex).map(item => {
            const level = ownedUpgrades[item.id] || 0;
            const currentCost = Math.floor(item.baseCost * Math.pow(item.costMult, level));
            const canBuy = coins >= currentCost;

            return (
              <button
                key={item.id}
                onClick={() => buyUpgrade(item)}
                disabled={!canBuy}
                className={`w-full p-3 rounded-xl flex items-center justify-between transition-all border border-white/5
                  ${canBuy ? 'bg-white/10 hover:bg-white/20' : 'bg-black/20 opacity-50 cursor-not-allowed'}
                `}
              >
                <div className="flex items-center gap-3 text-left">
                  <div className={`p-2 rounded-lg ${level > 0 ? 'bg-green-500 text-white' : 'bg-white/10'}`}>
                    {item.icon}
                  </div>
                  <div>
                    <div className="font-bold text-sm flex items-center gap-2">
                        {item.name} 
                        <span className="text-xs bg-black/40 px-1 rounded text-white/70">Lvl {level}</span>
                    </div>
                    <div className="text-xs opacity-70">
                      {item.type === 'click' ? `+${item.basePower} For√ßa/Lvl` : `+${item.basePower}% Auto/Lvl`}
                    </div>
                  </div>
                </div>
                
                <div className="flex flex-col items-end">
                    <div className={`font-mono font-bold text-sm ${canBuy ? 'text-yellow-400' : 'text-gray-400'}`}>
                    {currentCost.toLocaleString()}
                    </div>
                    <div className="text-[10px] uppercase opacity-50">Comprar</div>
                </div>
              </button>
            )
          })}
        </div>
      </div>
    </div>
  );
}
